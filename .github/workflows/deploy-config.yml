# GitHub Actions Workflow - Inject Secrets into Config
# This creates a config file from GitHub Secrets at build time

name: Build Config from Secrets

on:
  workflow_dispatch: # Manual trigger
  push:
    branches: [ main ]
    paths:
      - 'js/config.js.template' # Only run if template changes

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Create config from secrets
        run: |
          # This creates a config file that includes Worker URL from secrets
          # Note: We don't put credentials here - only Worker URL (which is public)
          cat > js/config-secrets.js << EOF
          // Auto-generated from GitHub Secrets
          // DO NOT EDIT - This file is generated by GitHub Actions
          
          const SECRETS_CONFIG = {
              // Cloudflare Worker URL (from GitHub Secrets)
              workerUrl: '${{ secrets.CLOUDFLARE_WORKER_URL || "" }}',
              
              // R2 Account ID (safe to store - public)
              r2AccountId: '${{ secrets.CLOUDFLARE_ACCOUNT_ID || "a4a6684b586aeee5dafd01cdd8492644" }}',
              r2BucketName: 'newvision'
          };
          
          if (typeof window !== 'undefined') {
              window.SECRETS_CONFIG = SECRETS_CONFIG;
          }
          EOF

      - name: Commit generated config
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add js/config-secrets.js
          git diff --staged --quiet || git commit -m "Update config from secrets"
          git push || echo "No changes to commit"
